<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo de Segurança - Ranking Compartilhado</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #222;
    padding: 1em;
    text-align: center;
    font-size: 1.4em;
    font-weight: bold;
  }
  main {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
    padding: 1em;
    justify-content: center;
  }
  .game-area, .ranking-area {
    background: #222;
    padding: 1em;
    border-radius: 8px;
  }
  .game-area {
    flex: 1 1 600px;
    max-width: 700px;
  }
  .ranking-area {
    flex: 1 1 300px;
    max-width: 350px;
    overflow-y: auto;
    max-height: 500px;
  }
  h2 {
    margin-top: 0;
    margin-bottom: 0.5em;
    color: #00d4ff;
  }
  button {
    background: #00d4ff;
    border: none;
    color: #111;
    padding: 0.5em 1em;
    cursor: pointer;
    font-weight: 700;
    border-radius: 4px;
    margin: 0.25em 0;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #modeSelector button {
    margin-right: 0.5em;
    border: 2px solid transparent;
  }
  #modeSelector button[aria-pressed="true"] {
    border-color: #00d4ff;
    background: #007ea7;
    color: #fff;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    color: #eee;
  }
  th, td {
    padding: 6px 8px;
    border-bottom: 1px solid #444;
    text-align: left;
  }
  th {
    background: #333;
  }
  #canvas {
    background: #000;
    display: block;
    margin: 1em 0;
    border-radius: 6px;
    width: 100%;
    height: 400px;
    max-width: 700px;
  }
  #quizBox button {
    width: 100%;
    text-align: left;
  }
  #interactiveBox input {
    width: 100%;
    padding: 0.5em;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #444;
    box-sizing: border-box;
  }
  #interactiveBox #missionMsg {
    font-size: 0.9em;
    margin-top: 0.5em;
    color: #aaf;
  }
  #endModal, #rulesModal {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  #endModal[aria-hidden="false"],
  #rulesModal[aria-hidden="false"] {
    display: flex;
  }
  #endModal .modal-content, #rulesModal .modal-content {
    background: #222;
    padding: 1em 1.5em;
    border-radius: 8px;
    max-width: 400px;
    width: 100%;
    color: #eee;
  }
  #endModal .modal-content input, #endModal .modal-content select {
    width: 100%;
    margin: 0.5em 0 1em 0;
    padding: 0.5em;
    border-radius: 4px;
    border: 1px solid #444;
    box-sizing: border-box;
  }
  #endModal .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5em;
  }
  #touchControls {
    display: none;
    margin-top: 1em;
    justify-content: center;
    gap: 0.5em;
  }
  #touchControls button {
    width: 40px;
    height: 40px;
    font-weight: 700;
    font-size: 1.2em;
    border-radius: 6px;
  }
  @media (max-width: 700px) {
    main {
      flex-direction: column;
      align-items: center;
    }
    .game-area, .ranking-area {
      max-width: 100%;
      flex: none;
    }
    #canvas {
      height: 300px;
    }
  }
</style>
</head>
<body>
<header>Jogo de Segurança - Ranking Compartilhado</header>
<main>
  <section class="game-area">
    <div id="modeSelector" role="group" aria-label="Selecione o modo do jogo">
      <button id="mode-avoid" aria-pressed="false">Desviar de Perigos</button>
      <button id="mode-quiz" aria-pressed="false">Quiz</button>
      <button id="mode-interactive" aria-pressed="false">Missão Interativa</button>
    </div>

    <div id="gameCard" style="margin-top:1em;">

      <canvas id="canvas" width="700" height="400" style="display:none;"></canvas>

      <div id="quizBox" style="display:none;"></div>

      <div id="interactiveBox" style="display:none;"></div>

      <div id="touchControls" aria-label="Controles de toque">
        <button data-dir="up" aria-label="Mover para cima">↑</button>
        <button data-dir="left" aria-label="Mover para esquerda">←</button>
        <button data-dir="down" aria-label="Mover para baixo">↓</button>
        <button data-dir="right" aria-label="Mover para direita">→</button>
      </div>

      <div style="margin-top: 1em;">
        <button id="btnStart" disabled>Iniciar</button>
        <button id="btnBack" style="margin-left: 0.5em;">Voltar</button>
        <span id="timer" style="margin-left: 1em;">Tempo: --</span>
        <span id="score" style="margin-left: 1em;">Pontos: 0</span>
      </div>
    </div>
  </section>

  <section class="ranking-area" aria-label="Ranking do jogo">
    <h2>Ranking por Nome</h2>
    <table>
      <thead><tr><th>#</th><th>Nome</th><th>Pontos</th></tr></thead>
      <tbody id="rankingNameBody"></tbody>
    </table>

    <h2>Ranking por Equipe</h2>
    <table>
      <thead><tr><th>#</th><th>Equipe</th><th>Pontos</th></tr></thead>
      <tbody id="rankingTeamBody"></tbody>
    </table>
  </section>
</main>

<!-- Modal fim de jogo -->
<div id="endModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="endModalTitle">
  <div class="modal-content">
    <h3 id="endModalTitle">Fim de jogo! Você fez <span id="modalPoints">0</span> pontos</h3>
    <label for="nameInput">Digite seu nome:</label>
    <input type="text" id="nameInput" maxlength="30" autocomplete="off" />
    <label for="teamSelect">Selecione sua equipe:</label>
    <select id="teamSelect">
      <option value="Core Team/Engenharia">Core Team/Engenharia</option>
      <option value="Manutenção e Ferramentaria">Manutenção e Ferramentaria</option>
      <option value="Montagem Traseiro">Montagem Traseiro</option>
      <option value="Montagem Dianteiro">Montagem Dianteiro</option>
      <option value="Buffer">Buffer</option>
      <option value="Finesse">Finesse</option>
      <option value="Injetoras">Injetoras</option>
      <option value="Carga e Descarga">Carga e Descarga</option>
    </select>
    <div class="modal-buttons">
      <button id="confirmSave">Salvar Resultado</button>
      <button id="skipSave">Pular</button>
    </div>
  </div>
</div>

<!-- Modal regras (pode implementar depois) -->
<div id="rulesModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="rulesModalTitle">
  <div class="modal-content">
    <h3 id="rulesModalTitle">Regras do Jogo</h3>
    <p>Regras e instruções vão aqui.</p>
    <button id="closeRulesBtn">Fechar</button>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyJLhJ4bEJggpP-GcwYxwXDkn8n7nZXvRdtYGtTucmtEgFFrAvaMZbdLRCa29HihLP9-A/exec';

const TEAMS = [
  "Core Team/Engenharia",
  "Manutenção e Ferramentaria",
  "Montagem Traseiro",
  "Montagem Dianteiro",
  "Buffer",
  "Finesse",
  "Injetoras",
  "Carga e Descarga"
];

let pointsThisRun = 0;
let currentMode = null;
let running = false;

/* ======= Utilidades ======= */
function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m]));
}

/* ========= RANKING ========= */
async function fetchRanking() {
  try {
    const res = await fetch(`${API_URL}?action=getRanking`);
    if(!res.ok) throw new Error('Falha ao buscar ranking');
    const data = await res.json();
    return data;
  } catch(e) {
    console.error(e);
    return { topNames: [], topTeams: [] };
  }
}

async function renderRankingByName() {
  const data = await fetchRanking();
  const arr = data.topNames || [];

  const rankingNameBody = document.getElementById('rankingNameBody');
  rankingNameBody.innerHTML = '';
  arr.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="width:28px">${i+1}</td>
                    <td>${escapeHtml(r.name)}</td>
                    <td style="text-align:right;font-weight:700">${r.points}</td>`;
    rankingNameBody.appendChild(tr);
  });
}

async function renderRankingByTeam() {
  const data = await fetchRanking();
  const arr = data.topTeams || [];

  const rankingTeamBody = document.getElementById('rankingTeamBody');
  rankingTeamBody.innerHTML = '';
  arr.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="width:28px">${i+1}</td>
                    <td class="team">${escapeHtml(r.team)}</td>
                    <td style="text-align:right;font-weight:700">${r.points}</td>`;
    rankingTeamBody.appendChild(tr);
  });
}

async function renderRanking() {
  await renderRankingByName();
  await renderRankingByTeam();
}

/* ========= ADICIONAR RESULTADO ========= */
async function addToRanking(name, team, points) {
  try {
    const params = new URLSearchParams({
      action: 'addScore',
      nome: name,
      equipe: team,
      pontos: points.toString(),
    });
    const res = await fetch(`${API_URL}?${params.toString()}`, {
      method: 'POST',
    });
    const data = await res.json();
    if(!data.success) throw new Error(data.message || 'Erro ao salvar resultado');
    await renderRanking();
  } catch(e) {
    alert('Erro ao salvar resultado: ' + e.message);
  }
}

/* ========= CONTROLE DE UI ========= */
function showElement(el) { el.style.display = ''; }
function hideElement(el) { el.style.display = 'none'; }

/* ========= MODO SELEÇÃO ========= */
const modeAvoid = document.getElementById('mode-avoid');
const modeQuiz = document.getElementById('mode-quiz');
const modeInteractive = document.getElementById('mode-interactive');
const btnStart = document.getElementById('btnStart');
const btnBack = document.getElementById('btnBack');
const timerEl = document.getElementById('timer');
const scoreEl = document.getElementById('score');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const quizBox = document.getElementById('quizBox');
const interactiveBox = document.getElementById('interactiveBox');
const touchControls = document.getElementById('touchControls');

const rankingNameBody = document.getElementById('rankingNameBody');
const rankingTeamBody = document.getElementById('rankingTeamBody');

const endModal = document.getElementById('endModal');
const modalPoints = document.getElementById('modalPoints');
const nameInput = document.getElementById('nameInput');
const teamSelect = document.getElementById('teamSelect');
const confirmSave = document.getElementById('confirmSave');
const skipSave = document.getElementById('skipSave');

let pointsThisRun = 0;
let currentMode = null;
let running = false;

/* ========= Reset seleção modo ========= */
function resetModeSelection() {
  [modeAvoid, modeQuiz, modeInteractive].forEach(m => {
    m.setAttribute('aria-pressed', 'false');
    m.style.borderColor = 'rgba(255,255,255,0.03)';
  });
}
function selectMode(modeId) {
  resetModeSelection();
  currentMode = modeId;
  const modeEl = document.getElementById('mode-' + modeId);
  modeEl.setAttribute('aria-pressed', 'true');
  modeEl.style.borderColor = '#00d4ff';
  startSetupForMode();
}

/* ========= Setup inicial modo ========= */
function startSetupForMode() {
  pointsThisRun = 0;
  timerEl.textContent = 'Tempo: --';
  scoreEl.textContent = 'Pontos: 0';
  btnStart.disabled = false;

  hideElement(canvas);
  hideElement(quizBox);
  hideElement(interactiveBox);
  hideElement(touchControls);

  showElement(document.getElementById('gameCard'));

  if(currentMode === 'avoid'){
    showElement(canvas);
    setupAvoidGame();
  } else if(currentMode === 'quiz'){
    showElement(quizBox);
    setupQuizGame();
  } else if(currentMode === 'interactive'){
    showElement(interactiveBox);
    setupInteractiveGame();
  }
}

/* ========= Voltar para seleção ========= */
btnBack.onclick = () => {
  running = false;
  currentMode = null;
  hideElement(document.getElementById('gameCard'));
  resetModeSelection();
  timerEl.textContent = 'Tempo: --';
  scoreEl.textContent = 'Pontos: 0';
};

/* ========= Modo 1: Desviar de Perigos ========= */
let avoidGame = {
  player: {x:350, y:350, size:30, speed:5},
  items: [],
  keysPressed: {},
  intervalId: null,
  frameCount: 0,
  spawnInterval: 40,
  gameDuration: 20,
  timerId: null
};
function setupAvoidGame(){
  avoidGame.player.x = 350;
  avoidGame.player.y = 350;
  avoidGame.items = [];
  avoidGame.keysPressed = {};
  avoidGame.frameCount = 0;
  running = false;
  timerEl.textContent = `Tempo: ${avoidGame.gameDuration}s`;
  scoreEl.textContent = 'Pontos: 0';

  window.addEventListener('keydown', avoidKeyDown);
  window.addEventListener('keyup', avoidKeyUp);

  touchControls.style.display = window.matchMedia("(pointer:coarse)").matches ? 'flex' : 'none';
  if(touchControls.style.display === 'flex'){
    [...touchControls.children].forEach(btn=>{
      btn.ontouchstart = () => avoidGame.keysPressed[btn.dataset.dir] = true;
      btn.ontouchend = () => avoidGame.keysPressed[btn.dataset.dir] = false;
      btn.onmousedown = () => avoidGame.keysPressed[btn.dataset.dir] = true;
      btn.onmouseup = () => avoidGame.keysPressed[btn.dataset.dir] = false;
      btn.onmouseleave = () => avoidGame.keysPressed[btn.dataset.dir] = false;
      btn.onkeydown = (e) => { if(e.key === "Enter" || e.key === " ") { avoidGame.keysPressed[btn.dataset.dir] = true; e.preventDefault(); } };
      btn.onkeyup = (e) => { if(e.key === "Enter" || e.key === " ") { avoidGame.keysPressed[btn.dataset.dir] = false; e.preventDefault(); } };
    });
  }
}
function avoidKeyDown(e){
  if(['ArrowUp','w','W'].includes(e.key)) avoidGame.keysPressed.up = true;
  if(['ArrowDown','s','S'].includes(e.key)) avoidGame.keysPressed.down = true;
  if(['ArrowLeft','a','A'].includes(e.key)) avoidGame.keysPressed.left = true;
  if(['ArrowRight','d','D'].includes(e.key)) avoidGame.keysPressed.right = true;
}
function avoidKeyUp(e){
  if(['ArrowUp','w','W'].includes(e.key)) avoidGame.keysPressed.up = false;
  if(['ArrowDown','s','S'].includes(e.key)) avoidGame.keysPressed.down = false;
  if(['ArrowLeft','a','A'].includes(e.key)) avoidGame.keysPressed.left = false;
  if(['ArrowRight','d','D'].includes(e.key)) avoidGame.keysPressed.right = false;
}
function startAvoidGame(){
  if(running) return;
  running = true;
  pointsThisRun = 0;
  avoidGame.items = [];
  avoidGame.frameCount = 0;
  timerEl.textContent = `Tempo: ${avoidGame.gameDuration}s`;
  scoreEl.textContent = 'Pontos: 0';

  avoidGame.intervalId = setInterval(gameLoopAvoid, 1000/60);
  avoidGame.timerId = setInterval(() => {
    avoidGame.gameDuration--;
    timerEl.textContent = `Tempo: ${avoidGame.gameDuration}s`;
    if(avoidGame.gameDuration <= 0) {
      endGame();
    }
  }, 1000);
}
function stopAvoidGame(){
  running = false;
  clearInterval(avoidGame.intervalId);
  clearInterval(avoidGame.timerId);
  window.removeEventListener('keydown', avoidKeyDown);
  window.removeEventListener('keyup', avoidKeyUp);
  touchControls.style.display = 'none';
}
function gameLoopAvoid(){
  avoidGame.frameCount++;
  // Spawn itens perigosos
  if(avoidGame.frameCount % avoidGame.spawnInterval === 0){
    avoidGame.items.push({
      x: Math.random()* (canvas.width - 30),
      y: -30,
      size: 30,
      speed: 3 + Math.random() * 3
    });
  }
  // Atualizar posição player
  if(avoidGame.keysPressed.up) avoidGame.player.y = Math.max(0, avoidGame.player.y - avoidGame.player.speed);
  if(avoidGame.keysPressed.down) avoidGame.player.y = Math.min(canvas.height - avoidGame.player.size, avoidGame.player.y + avoidGame.player.speed);
  if(avoidGame.keysPressed.left) avoidGame.player.x = Math.max(0, avoidGame.player.x - avoidGame.player.speed);
  if(avoidGame.keysPressed.right) avoidGame.player.x = Math.min(canvas.width - avoidGame.player.size, avoidGame.player.x + avoidGame.player.speed);
  // Atualizar itens
  avoidGame.items.forEach(item => {
    item.y += item.speed;
  });
  // Remover itens fora da tela
  avoidGame.items = avoidGame.items.filter(item => item.y < canvas.height + item.size);

  // Verificar colisões
  const playerRect = {
    x: avoidGame.player.x,
    y: avoidGame.player.y,
    w: avoidGame.player.size,
    h: avoidGame.player.size
  };
  let collision = false;
  for(let i=0; i<avoidGame.items.length; i++){
    const item = avoidGame.items[i];
    const itemRect = {x: item.x, y: item.y, w: item.size, h: item.size};
    if(rectIntersect(playerRect, itemRect)){
      collision = true;
      break;
    }
  }
  if(collision){
    endGame();
    return;
  }

  // Atualizar pontos (tempo vivo)
  pointsThisRun = avoidGame.gameDuration * 10; // exemplo: 10 pontos por segundo restante
  scoreEl.textContent = `Pontos: ${pointsThisRun}`;

  // Desenhar
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Player azul
  ctx.fillStyle = '#00d4ff';
  ctx.fillRect(avoidGame.player.x, avoidGame.player.y, avoidGame.player.size, avoidGame.player.size);
  // Itens vermelhos
  ctx.fillStyle = '#ff4444';
  avoidGame.items.forEach(item => {
    ctx.fillRect(item.x, item.y, item.size, item.size);
  });
}
function rectIntersect(r1, r2){
  return !(r2.x > r1.x + r1.w || 
           r2.x + r2.w < r1.x || 
           r2.y > r1.y + r1.h || 
           r2.y + r2.h < r1.y);
}

/* ========= Modo 2: Quiz ========= */
const quizQuestions = [
  {
    q: "Qual é o EPI obrigatório para proteção dos olhos?",
    options: ["Capacete", "Óculos de proteção", "Luvas", "Máscara"],
    answer: 1
  },
  {
    q: "O que significa a sigla NR?",
    options: ["Norma Regulamentadora", "Novo Registro", "Nota de Risco", "Nível de Ruído"],
    answer: 0
  },
  {
    q: "Qual é a principal causa de acidentes em chão de fábrica?",
    options: ["Falta de atenção", "Máquinas quebradas", "Ruído alto", "Iluminação fraca"],
    answer: 0
  }
];
let quizIndex = 0;
function setupQuizGame(){
  quizIndex = 0;
  quizBox.innerHTML = '';
  renderQuizQuestion();
}
function renderQuizQuestion(){
  const q = quizQuestions[quizIndex];
  quizBox.innerHTML = `<p><strong>${q.q}</strong></p>`;
  q.options.forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => quizAnswer(i);
    quizBox.appendChild(btn);
  });
}
function quizAnswer(selected){
  const correct = quizQuestions[quizIndex].answer;
  if(selected === correct){
    pointsThisRun += 10;
  }
  quizIndex++;
  if(quizIndex >= quizQuestions.length){
    endGame();
  } else {
    renderQuizQuestion();
  }
  scoreEl.textContent = `Pontos: ${pointsThisRun}`;
}

/* ========= Modo 3: Missão Interativa ========= */
function setupInteractiveGame(){
  interactiveBox.innerHTML = '';
  interactiveBox.innerHTML = `<label for="inputEU">Informe seu número do "EU ME PREOCUPO":</label><br/>
                             <input id="inputEU" type="text" maxlength="10" autocomplete="off" />
                             <div id="missionMsg"></div>`;
  pointsThisRun = 0;
  scoreEl.textContent = `Pontos: 0`;
  const inputEU = document.getElementById('inputEU');
  inputEU.oninput = () => {
    // Simples validação e pontuação
    if(inputEU.value.trim().length >= 3){
      pointsThisRun = 20;
      scoreEl.textContent = `Pontos: ${pointsThisRun}`;
      document.getElementById('missionMsg').textContent = 'Número válido!';
    } else {
      pointsThisRun = 0;
      scoreEl.textContent = `Pontos: ${pointsThisRun}`;
      document.getElementById('missionMsg').textContent = 'Informe ao menos 3 caracteres.';
    }
  };
}

/* ========= BOTÕES ========= */
btnStart.onclick = () => {
  if(running) return;
  if(!currentMode) {
    alert('Selecione um modo antes de iniciar.');
    return;
  }
  if(currentMode === 'avoid'){
    startAvoidGame();
  } else if(currentMode === 'quiz'){
    pointsThisRun = 0;
    running = true;
    renderQuizQuestion();
  } else if(currentMode === 'interactive'){
    pointsThisRun = 0;
    running = true;
  }
  btnStart.disabled = true;
};

confirmSave.onclick = async () => {
  const nome = nameInput.value.trim();
  const equipe = teamSelect.value;
  if(nome.length < 2){
    alert('Por favor, digite seu nome.');
    return;
  }
  await addToRanking(nome, equipe, pointsThisRun);
  endModal.setAttribute('aria-hidden', 'true');
  nameInput.value = '';
  pointsThisRun = 0;
  btnStart.disabled = false;
};

skipSave.onclick = () => {
  endModal.setAttribute('aria-hidden', 'true');
  pointsThisRun = 0;
  btnStart.disabled = false;
};

/* ========= FIM DE JOGO ========= */
function endGame(){
  running = false;
  btnStart.disabled = true;
  stopAvoidGame();
  modalPoints.textContent = pointsThisRun.toString();
  endModal.setAttribute('aria-hidden', 'false');
}

/* ========= INICIALIZAÇÃO ========= */
document.addEventListener('DOMContentLoaded', () => {
  resetModeSelection();
  renderRanking();
});

modeAvoid.onclick = () => selectMode('avoid');
modeQuiz.onclick = () => selectMode('quiz');
modeInteractive.onclick = () => selectMode('interactive');
</script>
</body>
</html>
